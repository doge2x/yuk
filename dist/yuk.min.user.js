// ==UserScript==
// @name         yuk-client
// @version      0.2.0
// @match        https://examination.xuetangx.com/exam/*
// @grant        GM.xmlHttpRequest
// @grant        GM_getValue
// @grant        GM_setValue
// @run-at       document-start
// ==/UserScript==

(()=>{var e=[,(e,t,n)=>{"use strict";n.r(t),n.d(t,{Client:()=>l});var r=n(2),o=n(8),i=n(9),s=n(14),a=function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{l(r.next(e))}catch(e){i(e)}}function a(e){try{l(r.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}l((r=r.apply(e,t||[])).next())}))};class l{constructor(){this.onmsg=[],this.queue=new Map;const e=new r.JSONRPCClient((t=>a(this,void 0,void 0,(function*(){const n=s.SERVER.value;null!==n&&(yield new Promise(((r,i)=>a(this,void 0,void 0,(function*(){yield o.default.xhr({url:n,method:"POST",headers:{"Content-Type":"application/json"},data:JSON.stringify(t),onload:t=>{200===t.status?(e.receive(JSON.parse(t.responseText)),r()):i(new Error(t.statusText))},onerror:e=>i(e.statusText)})})))))}))));this.client=e}watch(e){return a(this,void 0,void 0,(function*(){return new Promise(((t,n)=>{const r=setInterval((()=>{this.sendQueue().catch((e=>{clearInterval(r),alert("与服务器通信异常"),n(e)}))}),e)}))}))}sendQueue(){return a(this,void 0,void 0,(function*(){if(this.queue.size<1||null===s.USERNAME.value||null===s.SERVER.value||null===s.EXAM_ID.value||!1===s.SYNC_ANSWERS.value)return;let e=[...this.queue.values()];if(this.queue.clear(),null===s.TOKEN.value){(0,i.devLog)(`login to server: ${s.USERNAME.value}, ${s.EXAM_ID.value}`);const e=yield this.client.request("login",[s.USERNAME.value,s.EXAM_ID.value]);(0,i.devLog)("got token",e),s.TOKEN.value=e}this.postAnswers(s.TOKEN.value,e)}))}postAnswers(e,t){return a(this,void 0,void 0,(function*(){(0,i.devLog)("send answers",t);const n=yield this.client.request("answer_problem",[e,t]);(0,i.devLog)("receive answers",n),this.onmsg.forEach((e=>e(n)))}))}answerProblem(e){return a(this,void 0,void 0,(function*(){e.forEach((e=>{this.queue.set(e.problem_id,e)}))}))}onmessage(e){this.onmsg.push(e)}}},function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),o(n(3),t),o(n(4),t),o(n(6),t),o(n(7),t)},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{l(r.next(e))}catch(e){i(e)}}function a(e){try{l(r.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}l((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.JSONRPCClient=void 0;var i=n(4),s=n(5),a=function(){function e(e,t){this._send=e,this.createID=t,this.idToResolveMap=new Map,this.id=0}return e.prototype._createID=function(){return this.createID?this.createID():++this.id},e.prototype.timeout=function(e,t){var n=this;void 0===t&&(t=function(e){return(0,i.createJSONRPCErrorResponse)(e,s.DefaultErrorCode,"Request timeout")});var r=function(r,o){var i=setTimeout((function(){r.forEach((function(e){var r=n.idToResolveMap.get(e);r&&(n.idToResolveMap.delete(e),r(t(e)))}))}),e);return o().then((function(e){return clearTimeout(i),e}),(function(e){return clearTimeout(i),Promise.reject(e)}))};return{request:function(e,t,o){var i=n._createID();return r([i],(function(){return n.requestWithID(e,t,o,i)}))},requestAdvanced:function(e,t){return function(e,t){var o=(Array.isArray(e)?e:[e]).map((function(e){return e.id})).filter(l);return r(o,(function(){return n.requestAdvanced(e,t)}))}(e,t)}}},e.prototype.request=function(e,t,n){return this.requestWithID(e,t,n,this._createID())},e.prototype.requestWithID=function(e,t,n,s){return r(this,void 0,void 0,(function(){var r,a;return o(this,(function(o){switch(o.label){case 0:return r={jsonrpc:i.JSONRPC,method:e,params:t,id:s},[4,this.requestAdvanced(r,n)];case 1:return void 0===(a=o.sent()).result||a.error?void 0===a.result&&a.error?[2,Promise.reject(new Error(a.error.message))]:[2,Promise.reject(new Error("An unexpected error occurred"))]:[2,a.result]}}))}))},e.prototype.requestAdvanced=function(e,t){var n=this,r=Array.isArray(e);Array.isArray(e)||(e=[e]);var o=e.filter((function(e){return l(e.id)})),a=o.map((function(e){return new Promise((function(t){return n.idToResolveMap.set(e.id,t)}))})),u=Promise.all(a).then((function(e){return r||!e.length?e:e[0]}));return this.send(r?e:e[0],t).then((function(){return u}),(function(e){return o.forEach((function(t){n.receive((0,i.createJSONRPCErrorResponse)(t.id,s.DefaultErrorCode,e&&e.message||"Failed to send a request"))})),u}))},e.prototype.notify=function(e,t,n){this.send({jsonrpc:i.JSONRPC,method:e,params:t},n).then(void 0,(function(){}))},e.prototype.send=function(e,t){return this._send(e,t)},e.prototype.rejectAllPendingRequests=function(e){this.idToResolveMap.forEach((function(t,n){return t((0,i.createJSONRPCErrorResponse)(n,s.DefaultErrorCode,e))})),this.idToResolveMap.clear()},e.prototype.receive=function(e){var t=this;Array.isArray(e)||(e=[e]),e.forEach((function(e){var n=t.idToResolveMap.get(e.id);n&&(t.idToResolveMap.delete(e.id),n(e))}))},e}();t.JSONRPCClient=a;var l=function(e){return null!=e}},(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createJSONRPCErrorResponse=t.JSONRPCErrorCode=t.isJSONRPCResponses=t.isJSONRPCResponse=t.isJSONRPCRequests=t.isJSONRPCRequest=t.isJSONRPCID=t.JSONRPC=void 0,t.JSONRPC="2.0";t.isJSONRPCID=function(e){return"string"==typeof e||"number"==typeof e||null===e};t.isJSONRPCRequest=function(e){return e.jsonrpc===t.JSONRPC&&void 0!==e.method&&void 0===e.result&&void 0===e.error};t.isJSONRPCRequests=function(e){return Array.isArray(e)&&e.every(t.isJSONRPCRequest)};t.isJSONRPCResponse=function(e){return e.jsonrpc===t.JSONRPC&&void 0!==e.id&&(void 0!==e.result||void 0!==e.error)};t.isJSONRPCResponses=function(e){return Array.isArray(e)&&e.every(t.isJSONRPCResponse)},function(e){e[e.ParseError=-32700]="ParseError",e[e.InvalidRequest=-32600]="InvalidRequest",e[e.MethodNotFound=-32601]="MethodNotFound",e[e.InvalidParams=-32602]="InvalidParams",e[e.InternalError=-32603]="InternalError"}(t.JSONRPCErrorCode||(t.JSONRPCErrorCode={}));t.createJSONRPCErrorResponse=function(e,n,r,o){var i={code:n,message:r};return o&&(i.data=o),{jsonrpc:t.JSONRPC,id:e,error:i}}},(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultErrorCode=void 0,t.DefaultErrorCode=0},function(e,t,n){"use strict";var r=this&&this.__assign||function(){return r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},r.apply(this,arguments)},o=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{l(r.next(e))}catch(e){i(e)}}function a(e){try{l(r.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}l((r=r.apply(e,t||[])).next())}))},i=this&&this.__generator||function(e,t){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},s=this&&this.__spreadArray||function(e,t,n){if(n||2===arguments.length)for(var r,o=0,i=t.length;o<i;o++)!r&&o in t||(r||(r=Array.prototype.slice.call(t,0,o)),r[o]=t[o]);return e.concat(r||Array.prototype.slice.call(t))};Object.defineProperty(t,"__esModule",{value:!0}),t.JSONRPCServer=void 0;var a=n(4),l=n(5),u=function(e){return(0,a.createJSONRPCErrorResponse)((0,a.isJSONRPCID)(e.id)?e.id:null,a.JSONRPCErrorCode.InvalidRequest,"Invalid Request")},c=function(){function e(e){var t;void 0===e&&(e={}),this.mapErrorToJSONRPCErrorResponse=p,this.nameToMethodDictionary={},this.middleware=null,this.errorListener=null!==(t=e.errorListener)&&void 0!==t?t:console.warn}return e.prototype.addMethod=function(e,t){this.addMethodAdvanced(e,this.toJSONRPCMethod(t))},e.prototype.toJSONRPCMethod=function(e){return function(t,n){var r=e(t.params,n);return Promise.resolve(r).then((function(e){return h(t.id,e)}))}},e.prototype.addMethodAdvanced=function(e,t){var n;this.nameToMethodDictionary=r(r({},this.nameToMethodDictionary),((n={})[e]=t,n))},e.prototype.receiveJSON=function(e,t){var n=this.tryParseRequestJSON(e);return n?this.receive(n,t):Promise.resolve((0,a.createJSONRPCErrorResponse)(null,a.JSONRPCErrorCode.ParseError,"Parse error"))},e.prototype.tryParseRequestJSON=function(e){try{return JSON.parse(e)}catch(e){return null}},e.prototype.receive=function(e,t){return Array.isArray(e)?this.receiveMultiple(e,t):this.receiveSingle(e,t)},e.prototype.receiveMultiple=function(e,t){return o(this,void 0,void 0,(function(){var n,r=this;return i(this,(function(o){switch(o.label){case 0:return[4,Promise.all(e.map((function(e){return r.receiveSingle(e,t)})))];case 1:return 1===(n=o.sent().filter(d)).length?[2,n[0]]:n.length?[2,n]:[2,null]}}))}))},e.prototype.receiveSingle=function(e,t){return o(this,void 0,void 0,(function(){var n,r;return i(this,(function(o){switch(o.label){case 0:return n=this.nameToMethodDictionary[e.method],(0,a.isJSONRPCRequest)(e)?[3,1]:[2,u(e)];case 1:return n?[4,this.callMethod(n,e,t)]:[3,3];case 2:return r=o.sent(),[2,v(e,r)];case 3:return void 0!==e.id?[2,(i=e.id,(0,a.createJSONRPCErrorResponse)(i,a.JSONRPCErrorCode.MethodNotFound,"Method not found"))]:[2,null];case 4:return[2]}var i}))}))},e.prototype.applyMiddleware=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.middleware?this.middleware=this.combineMiddlewares(s([this.middleware],e,!0)):this.middleware=this.combineMiddlewares(e)},e.prototype.combineMiddlewares=function(e){return e.length?e.reduce(this.middlewareReducer):null},e.prototype.middlewareReducer=function(e,t){return function(n,r,o){return e((function(e,r){return t(n,e,r)}),r,o)}},e.prototype.callMethod=function(e,t,n){var r=this,o=function(e){return r.errorListener('An unexpected error occurred while executing "'.concat(t.method,'" JSON-RPC method:'),e),Promise.resolve(r.mapErrorToJSONRPCErrorResponseIfNecessary(t.id,e))};try{return(this.middleware||f)((function(t,n){return e(t,n)}),t,n).then(void 0,o)}catch(e){return o(e)}},e.prototype.mapErrorToJSONRPCErrorResponseIfNecessary=function(e,t){return void 0!==e?this.mapErrorToJSONRPCErrorResponse(e,t):null},e}();t.JSONRPCServer=c;var d=function(e){return null!==e},f=function(e,t,n){return e(t,n)},h=function(e,t){return void 0!==e?{jsonrpc:a.JSONRPC,id:e,result:void 0===t?null:t}:null},p=function(e,t){return(0,a.createJSONRPCErrorResponse)(e,l.DefaultErrorCode,t&&t.message||"An unexpected error occurred")},v=function(e,t){return t||(void 0!==e.id?(0,a.createJSONRPCErrorResponse)(e.id,a.JSONRPCErrorCode.InternalError,"Internal error"):null)}},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{l(r.next(e))}catch(e){i(e)}}function a(e){try{l(r.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}l((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.JSONRPCServerAndClient=void 0;var i=n(4),s=function(){function e(e,t,n){var r;void 0===n&&(n={}),this.server=e,this.client=t,this.errorListener=null!==(r=n.errorListener)&&void 0!==r?r:console.warn}return e.prototype.applyServerMiddleware=function(){for(var e,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];(e=this.server).applyMiddleware.apply(e,t)},e.prototype.addMethod=function(e,t){this.server.addMethod(e,t)},e.prototype.addMethodAdvanced=function(e,t){this.server.addMethodAdvanced(e,t)},e.prototype.timeout=function(e){return this.client.timeout(e)},e.prototype.request=function(e,t,n){return this.client.request(e,t,n)},e.prototype.requestAdvanced=function(e,t){return this.client.requestAdvanced(e,t)},e.prototype.notify=function(e,t,n){this.client.notify(e,t,n)},e.prototype.rejectAllPendingRequests=function(e){this.client.rejectAllPendingRequests(e)},e.prototype.receiveAndSend=function(e,t,n){return r(this,void 0,void 0,(function(){var r,s;return o(this,(function(o){switch(o.label){case 0:return(0,i.isJSONRPCResponse)(e)||(0,i.isJSONRPCResponses)(e)?(this.client.receive(e),[3,4]):[3,1];case 1:return(0,i.isJSONRPCRequest)(e)||(0,i.isJSONRPCRequests)(e)?[4,this.server.receive(e,t)]:[3,3];case 2:return(r=o.sent())?[2,this.client.send(r,n)]:[3,4];case 3:return s="Received an invalid JSON-RPC message",this.errorListener(s,e),[2,Promise.reject(new Error(s))];case 4:return[2]}}))}))},e}();t.JSONRPCServerAndClient=s},(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>r});const r={getValue:e=>GM_getValue(e),setValue:(e,t)=>GM_setValue(e,t),xhr:async e=>await GM.xmlHttpRequest(e)}},(e,t,n)=>{"use strict";n.r(t),n.d(t,{Map2:()=>a,devLog:()=>s,newURL:()=>c,openWin:()=>u,percent:()=>l});var r=n(10),o=n.n(r),i=n(13);function s(e,...t){0}class a extends Map{constructor(e){super(),this.def=e}setWith(e,t){var n;super.set(e,t(null!==(n=super.get(e))&&void 0!==n?n:this.def()))}}function l(e){return`${Math.floor(100*e)}%`}function u(e,t){t=null!=t?t:{};const n=window.open(void 0,void 0,Object.entries({location:"no",height:t.height,width:t.width,left:t.left,top:t.top,resizable:"yes",menubar:"no",scrollbars:"yes",status:"no",titlebar:"no",toolbar:"no"}).map((([e,t])=>`${e}=${t}`)).join(","));return window.addEventListener("unload",(()=>n.close())),n.document.head.append(i.default.createElement(i.default.Fragment,null,i.default.createElement("title",null,e),i.default.createElement("style",null,o().toString()))),n}function c(e,t){const n=new URL(e,self.location.origin);for(const[e,r]of Object.entries(null!=t?t:{}))n.searchParams.set(e,r);return n}},(e,t,n)=>{var r=n(11),o=n(12)(r);o.push([e.id,".K7vQwtugDxkOfU77fg4J {\n  font-size: 0.5rem;\n  opacity: 0.5;\n}\n\n.C2I4DvlMSfimZfl_xPn0 p {\n  margin: 0;\n}\n\n.C2I4DvlMSfimZfl_xPn0 ul {\n  margin: 0;\n  padding-left: 1.5rem;\n}\n\n.C2I4DvlMSfimZfl_xPn0 img {\n  height: auto;\n  width: 80%;\n}\n\n.C2I4DvlMSfimZfl_xPn0 .Njk3jLX2FgrdznVCqYh5 {\n  font-weight: bold;\n}\n\n.C2I4DvlMSfimZfl_xPn0 .yZIu6SlfivGi6blasrPS {\n  border-style: groove;\n  border-width: thin;\n  margin: 0.2rem;\n  padding: 0.2rem;\n}\n\n.mcfTbD5P0GwQwMJOmYD5 {\n  cursor: pointer;\n}\n\n.ogPrX91zgEreh2bN9mhh {\n  display: flex;\n  flex-direction: column;\n}\n\n.ogPrX91zgEreh2bN9mhh .jVC6DpTyv93BozsU0r_Q {\n  display: flex;\n  flex-direction: row;\n  margin-bottom: 0.5rem;\n  justify-content: space-between;\n}\n\n.ogPrX91zgEreh2bN9mhh .jVC6DpTyv93BozsU0r_Q label {\n  display: flex;\n  flex-direction: column;\n  justify-content: center;\n  font-weight: bold;\n}\n\n.ogPrX91zgEreh2bN9mhh .jVC6DpTyv93BozsU0r_Q input {\n  text-align: right;\n}\n\n.ogPrX91zgEreh2bN9mhh .TGZ9H1pYsrQDZ5TLZZXX {\n  display: flex;\n  flex-direction: row;\n  justify-content: flex-end;\n}\n\n.ogPrX91zgEreh2bN9mhh .TGZ9H1pYsrQDZ5TLZZXX input {\n  cursor: pointer;\n}\n\n.ogPrX91zgEreh2bN9mhh .UeVqvz4xIIdNv68ajZbg {\n  display: flex;\n  flex-direction: row;\n  justify-content: flex-end;\n  font-style: italic;\n  font-size: 0.3rem;\n}\n\n.Gu11L3zStV2T8FRx34Gu {\n  display: flex;\n  flex-direction: column;\n}\n\n.Gu11L3zStV2T8FRx34Gu img {\n  width: 100%;\n  height: auto;\n}\n\n.Gu11L3zStV2T8FRx34Gu .tw3KNVkLhuhtS7HuVpZm {\n  cursor: pointer;\n  margin-bottom: 0.5rem;\n}\n\n.Gu11L3zStV2T8FRx34Gu .pvyAMUVLQ5TZqHUQGRaz {\n  border-style: groove;\n  border-width: thin;\n  padding: 0.5rem;\n}\n\n.qN5pz3Z5naDIp60s9Di8 strong {\n  font-weight: bold;\n}\n\n.qN5pz3Z5naDIp60s9Di8 p {\n  margin-bottom: 0.25rem;\n}\n\n.qN5pz3Z5naDIp60s9Di8 ul {\n  padding-left: 1.5rem;\n  margin-bottom: 0.25rem;\n}\n\n.qN5pz3Z5naDIp60s9Di8 ul li {\n  margin-bottom: 0.25rem;\n}\n",""]),o.locals={mainBody:"K7vQwtugDxkOfU77fg4J",answerDetail:"C2I4DvlMSfimZfl_xPn0",title:"Njk3jLX2FgrdznVCqYh5",shorAnswer:"yZIu6SlfivGi6blasrPS",clickable:"mcfTbD5P0GwQwMJOmYD5",settings:"ogPrX91zgEreh2bN9mhh",settingsEntry:"jVC6DpTyv93BozsU0r_Q",settingsSubmit:"TGZ9H1pYsrQDZ5TLZZXX",submitTip:"UeVqvz4xIIdNv68ajZbg",uploadImg:"Gu11L3zStV2T8FRx34Gu",confirmUpload:"tw3KNVkLhuhtS7HuVpZm",imageContainer:"pvyAMUVLQ5TZqHUQGRaz",about:"qN5pz3Z5naDIp60s9Di8"},e.exports=o},e=>{"use strict";e.exports=function(e){return e[1]}},e=>{"use strict";e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var n="",r=void 0!==t[5];return t[4]&&(n+="@supports (".concat(t[4],") {")),t[2]&&(n+="@media ".concat(t[2]," {")),r&&(n+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),n+=e(t),r&&(n+="}"),t[2]&&(n+="}"),t[4]&&(n+="}"),n})).join("")},t.i=function(e,n,r,o,i){"string"==typeof e&&(e=[[null,e,void 0]]);var s={};if(r)for(var a=0;a<this.length;a++){var l=this[a][0];null!=l&&(s[l]=!0)}for(var u=0;u<e.length;u++){var c=[].concat(e[u]);r&&s[c[0]]||(void 0!==i&&(void 0===c[5]||(c[1]="@layer".concat(c[5].length>0?" ".concat(c[5]):""," {").concat(c[1],"}")),c[5]=i),n&&(c[2]?(c[1]="@media ".concat(c[2]," {").concat(c[1],"}"),c[2]=n):c[2]=n),o&&(c[4]?(c[1]="@supports (".concat(c[4],") {").concat(c[1],"}"),c[4]=o):c[4]="".concat(o)),t.push(c))}},t}},(e,t,n)=>{"use strict";function r(e,t){for(const n of t)n instanceof Node?e.appendChild(n):e.appendChild(document.createTextNode(String(n)))}function o(e,t){for(const[n,r]of Object.entries(t))n.startsWith("-")?e.style.setProperty(n,r):e.style[n]=r}n.r(t),n.d(t,{default:()=>i});const i={createElement(e,t,...n){let i=function(e){let t=[];for(const n of e)Array.isArray(n)?t=t.concat(n):t.push(n);return t}(n);if("function"==typeof e)return e(Object.assign(Object.assign({},t),{children:i}));{const n=document.createElement(e);r(n,i);for(const[e,r]of Object.entries(null!=t?t:{}))if(void 0!==r)switch(e){case"classList":n.classList.add(...r);break;case"style":o(n,r);break;case"dangerouslySetInnerHTML":n.innerHTML=r.__html;break;default:e.startsWith("on-")?n.addEventListener(e.slice(3),r):e in n&&(n[e]=r)}return n}},Fragment(e){let t=document.createDocumentFragment();return Array.isArray(e.children)&&r(t,e.children),t}}},(e,t,n)=>{"use strict";n.r(t),n.d(t,{EXAM_ID:()=>h,NO_LEAVE_CHECK:()=>c,NO_SCREENSHOTS:()=>d,SERVER:()=>a,SORT_PROBLEMS:()=>u,SYNC_ANSWERS:()=>l,TOKEN:()=>f,USERNAME:()=>s});var r=n(8);class o{constructor(e){this._value=null,this._value=null!=e?e:null}get value(){return this._value}set value(e){this._value=e}}class i extends o{constructor(e,t){let n=r.default.getValue(e);void 0===n&&void 0!==t&&(r.default.setValue(e,t),n=t),super(n),this.name=e}get value(){return super.value}set value(e){r.default.setValue(this.name,e),super.value=e}}const s=new i("username"),a=new i("server"),l=new i("sync_answers",!0),u=new i("sort_problems",!0),c=new i("no_leave_check",!0),d=new i("no_screenshots",!1),f=new o,h=new o},(e,t,n)=>{"use strict";n.r(t),n.d(t,{hookXHR:()=>o});var r=n(9);function o(e){const t=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(n,o){const i=e.call(this,(0,r.newURL)(o)),s=this.send;this.send=function(e){void 0!==i?i(e).then((e=>{s.call(this,e),this.send=s})).catch(r.devLog):(s.call(this,e),this.send=s)},t.apply(this,arguments)}}},(e,t,n)=>{"use strict";var r;function o(e){return e===r.SingleChoice||e===r.MultipleChoice||e===r.Polling}n.r(t),n.d(t,{ProblemType:()=>r,isChoice:()=>o}),function(e){e[e.SingleChoice=1]="SingleChoice",e[e.MultipleChoice=2]="MultipleChoice",e[e.Polling=3]="Polling",e[e.FillBlank=4]="FillBlank",e[e.ShortAnswer=5]="ShortAnswer",e[e.Judgement=6]="Judgement"}(r||(r={}))},(e,t,n)=>{"use strict";n.r(t),n.d(t,{UI:()=>u});var r=n(10),o=n.n(r),i=n(9),s=n(18),a=n(13),l=n(14);class u{constructor(e){document.head.append(a.default.createElement("style",null,o().toString()));const t=document.body.querySelector(".header-title");t.classList.add(r.locals.clickable),t.addEventListener("click",(()=>{var e,t;const n=(0,i.openWin)("设置",{height:150,width:200});function o(e){var t;return a.default.createElement("div",{classList:[r.locals.settingsEntry]},a.default.createElement("label",{htmlFor:e.name},e.title),a.default.createElement("input",{name:e.name,title:e.title,size:e.size,type:null!==(t=e.type)&&void 0!==t?t:"text",required:!0===e.required,pattern:e.pattern,value:e.value,checked:e.checked}))}n.document.body.append(a.default.createElement("div",{classList:[r.locals.mainBody,r.locals.settings]},a.default.createElement("form",{onsubmit:()=>!1,"on-submit":function(){const e=new FormData(this);l.USERNAME.value=e.get("username"),l.SERVER.value=e.get("server"),l.NO_LEAVE_CHECK.value="on"===e.get("no_leave_check"),l.SORT_PROBLEMS.value="on"===e.get("sort_problems"),l.SYNC_ANSWERS.value="on"===e.get("sync_answers"),l.NO_SCREENSHOTS.value="on"===e.get("no_screenshots"),n.close()}},a.default.createElement(o,{name:"username",title:"用户名",pattern:"[_a-z][_a-z0-9]*",size:10,value:null!==(e=l.USERNAME.value)&&void 0!==e?e:void 0}),a.default.createElement(o,{name:"server",title:"服务器地址",pattern:".*",size:15,value:null!==(t=l.SERVER.value)&&void 0!==t?t:void 0}),a.default.createElement(o,{name:"sync_answers",title:"同步答案",checked:!0===l.SYNC_ANSWERS.value,type:"checkbox"}),a.default.createElement(o,{name:"sort_problems",title:"排序题目",checked:!0===l.SORT_PROBLEMS.value,type:"checkbox"}),a.default.createElement(o,{name:"no_leave_check",title:"拦截切屏检测",checked:!0===l.NO_LEAVE_CHECK.value,type:"checkbox"}),a.default.createElement(o,{name:"no_screenshots",title:"拦截全部截图",checked:!0===l.NO_SCREENSHOTS.value,type:"checkbox"}),a.default.createElement("div",{classList:[r.locals.submitTip]},a.default.createElement("p",null,"*更改设置后请刷新页面")),a.default.createElement("div",{classList:[r.locals.settingsSubmit]},a.default.createElement("input",{type:"submit",value:"提交",size:10}))),a.default.createElement("div",{classList:[r.locals.about]},a.default.createElement("p",null,a.default.createElement("strong",null,"功能特性：")),a.default.createElement("ul",null,a.default.createElement("li",null,a.default.createElement("strong",null,"同步答案："),"点击题目显示详细答案，在选项/填空处悬停鼠标显示简略答案"),a.default.createElement("li",null,a.default.createElement("strong",null,"排序题目："),"根据题目 ID 和选项对试卷进行重新排序"),a.default.createElement("li",null,a.default.createElement("strong",null,"拦截切屏检测："),"随意切换页面、窗口不会被发现"),a.default.createElement("li",null,a.default.createElement("strong",null,"拦截上传截图："),"仅当用户确认时，才会上传截图，启用",a.default.createElement("strong",null,"[拦截全部截图]"),"后，所有截图默认取消上传"),a.default.createElement("li",null,a.default.createElement("strong",null,"阻止提交异常状态："),"即使页面显示异常状态也不会被提交到服务器")))))}));const n=new Map;document.body.querySelectorAll(".exam-main--body .subject-item").forEach(((t,r)=>{const o=e.data.problems[r];n.set(o.problem_id,new s.ProblemCard(o,t))})),this.problems=n}updateAnswer({username:e,problem_id:t,result:n}){var r;null===(r=this.problems.get(t))||void 0===r||r.updateResult(e,n)}updateUI(){this.problems.forEach((e=>e.updateUI()))}}},(e,t,n)=>{"use strict";n.r(t),n.d(t,{ProblemCard:()=>u});var r=n(16),o=n(9),i=n(10),s=n(13);class a{constructor(e){if(!(e instanceof HTMLElement))throw new Error("not a html element");this.ele=e}get content(){return this.ele.title}set content(e){this.ele.title=e}}function l(e){return`${Math.floor(100*e)}%`}class u{constructor(e,t){this.results=new Map;const n=e.ProblemType,o=new Map,s=t.querySelector(".item-type");switch(s.classList.add(i.locals.clickable),s.addEventListener("click",(()=>this.showAll(s.getBoundingClientRect()))),n){case r.ProblemType.SingleChoice:case r.ProblemType.MultipleChoice:case r.ProblemType.Polling:case r.ProblemType.Judgement:t.querySelectorAll(".item-body .checkboxInput, .item-body .radioInput").forEach(((t,n)=>{o.set(e.Options[n].key,new a(t))}));break;case r.ProblemType.FillBlank:t.querySelectorAll(".item-body .blank-item-dynamic").forEach(((e,t)=>{o.set(`${t+1}`,new a(e))}))}this.type=n,this.options=o}showAll({left:e,top:t}){const n=(0,o.openWin)("详细答案",{height:150,width:200,left:e,top:t}),a=s.default.createElement("div",{classList:[i.locals.mainBody,i.locals.answerDetail]});function l(e){return s.default.createElement("p",{className:!0===e.title?i.locals.title:""},e.children)}function u(e){return s.default.createElement("ul",null,Array.isArray(e.children)?e.children.map((e=>s.default.createElement("li",null,e))):e.children)}switch(n.document.body.append(a),this.type){case r.ProblemType.SingleChoice:case r.ProblemType.MultipleChoice:case r.ProblemType.Polling:case r.ProblemType.Judgement:const e=new o.Map2((()=>[]));this.results.forEach(((t,n)=>{t.forEach((t=>{e.setWith(t,(e=>(e.push(n),e)))}))})),[...e.entries()].sort((([e],[t])=>e<t?-1:1)).forEach((([e,t])=>{a.append(s.default.createElement("div",null,s.default.createElement(l,{title:!0},e),s.default.createElement(u,null,t.sort().map((e=>s.default.createElement(l,null,e))))))}));break;case r.ProblemType.FillBlank:const t=new o.Map2((()=>new o.Map2((()=>[]))));this.results.forEach(((e,n)=>{Object.entries(e).forEach((([e,r])=>{t.setWith(e,(e=>(e.setWith(r,(e=>(e.push(n),e))),e)))}))})),[...t.entries()].sort((([e],[t])=>e<t?-1:1)).forEach((([e,t])=>{a.append(s.default.createElement("div",null,s.default.createElement(l,{title:!0},`#${e}`),s.default.createElement(u,null,[...t].sort((([e],[t])=>e<t?-1:1)).map((([e,t])=>s.default.createElement(s.default.Fragment,null,s.default.createElement(l,null,e),s.default.createElement(u,null,t.sort().map((e=>s.default.createElement(l,null,e))))))))))}));break;case r.ProblemType.ShortAnswer:a.append(s.default.createElement(u,null,[...this.results.entries()].sort((([e],[t])=>e<t?-1:1)).map((([e,t])=>{var n,r;return s.default.createElement(s.default.Fragment,null,s.default.createElement(l,{title:!0},e),s.default.createElement("div",null,s.default.createElement("div",{className:i.locals.shorAnswer,dangerouslySetInnerHTML:{__html:t.content}}),s.default.createElement(u,null,(null!==(r=null===(n=t.attachments)||void 0===n?void 0:n.filelist)&&void 0!==r?r:[]).map((e=>s.default.createElement("a",{href:e.fileUrl},e.fileName))))))}))))}}updateResult(e,t){this.results.set(e,t)}updateUI(){switch(this.options.forEach((e=>e.content="")),this.type){case r.ProblemType.SingleChoice:case r.ProblemType.MultipleChoice:case r.ProblemType.Polling:case r.ProblemType.Judgement:const e=new o.Map2((()=>0));this.results.forEach((t=>{t.forEach((t=>{e.setWith(t,(e=>e+1))}))})),e.forEach(((e,t)=>{this.options.get(t).content=`${l(e/this.results.size)}`}));break;case r.ProblemType.FillBlank:const t=new o.Map2((()=>new o.Map2((()=>0))));this.results.forEach((e=>{Object.entries(e).forEach((([e,n])=>{t.setWith(e,(e=>(e.setWith(n,(e=>e+1)),e)))}))})),t.forEach(((e,t)=>{const[n,r]=[...e.entries()].sort((([e,t],[n,r])=>t-r)).pop();this.options.get(t).content=`(${l(r/this.results.size)}) ${n}`}))}}}}],t={};function n(r){var o=t[r];if(void 0!==o)return o.exports;var i=t[r]={id:r,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var r={};(()=>{"use strict";n.r(r),n.d(r,{sortPaper:()=>d});var e=n(1),t=n(15),o=n(16),i=n(17),s=n(9),a=n(14),l=n(13),u=n(10),c=function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{l(r.next(e))}catch(e){i(e)}}function a(e){try{l(r.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}l((r=r.apply(e,t||[])).next())}))};function d(e){return e.data.problems.sort(((e,t)=>e.problem_id-t.problem_id)),e.data.problems.forEach((e=>{(0,o.isChoice)(e.ProblemType)&&e.Options.sort(((e,t)=>e.key<t.key?-1:1))})),e}(function(){return c(this,void 0,void 0,(function*(){!0===a.NO_LEAVE_CHECK.value&&(document.addEventListener("visibilitychange",(e=>{e.preventDefault(),e.stopImmediatePropagation()}),!0),window.addEventListener("visibilitychange",(e=>{e.preventDefault(),e.stopImmediatePropagation()}),!0));const n=new e.Client;(0,t.hookXHR)((function(e){switch(e.pathname){case"/exam_room/show_paper":this.addEventListener("readystatechange",(()=>{if(this.readyState==XMLHttpRequest.DONE&&!0===a.SORT_PROBLEMS.value){const e=JSON.stringify(d(JSON.parse(this.responseText)));Object.defineProperties(this,{responseText:{get:()=>e}})}})),this.addEventListener("load",(()=>{const t=new i.UI(JSON.parse(this.responseText));n.onmessage((e=>{e.forEach((e=>t.updateAnswer(e))),t.updateUI()})),(()=>c(this,void 0,void 0,(function*(){a.EXAM_ID.value=parseInt(e.searchParams.get("exam_id"));const t=yield fetch((0,s.newURL)("/exam_room/cache_results",{exam_id:a.EXAM_ID.value.toString()}).toString()).then((e=>e.json()));n.answerProblem(t.data.results)})))().catch(s.devLog)}));break;case"/exam_room/answer_problem":return e=>c(this,void 0,void 0,(function*(){var t;if("string"==typeof e){const r=JSON.parse(e);if("action"in r)switch(r.action){case 1:case 17:break;default:return console.log("Intercept actions",r),new Promise((()=>{}))}else"results"in r&&((0,s.devLog)("Intercept answers",r),n.answerProblem(null!==(t=r.results)&&void 0!==t?t:[]).catch(s.devLog))}return e}));default:if("upload-z1.qiniup.com"===e.hostname)return e=>c(this,void 0,void 0,(function*(){return e instanceof FormData&&e.get("file")instanceof File?!0===a.NO_SCREENSHOTS.value?new Promise((()=>{})):new Promise((t=>{const n=new FileReader;n.onload=()=>{const r=(0,s.openWin)("上传图片",{width:300,height:200});r.document.body.append(l.default.createElement("div",{classList:[u.locals.uploadImg,u.locals.mainBody]},l.default.createElement("div",null,l.default.createElement("button",{"on-click":()=>{t(e),r.close()},classList:[u.locals.confirmUpload],type:"button"},"确认上传")),l.default.createElement("div",{classList:[u.locals.imageContainer]},l.default.createElement("img",{src:n.result}))))},n.readAsDataURL(e.get("file"))})):e}))}})),yield n.watch(1e4)}))})().catch(console.error)})()})();