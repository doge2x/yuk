// ==UserScript==
// @name         yuk
// @version      0.1.0
// @match        https://examination.xuetangx.com/exam/*
// @grant        GM_getValue
// @grant        GM_setValue
// @run-at       document-start
// ==/UserScript==

(()=>{function c(t){return t.data.problems.sort((e,s)=>e.problem_id-s.problem_id),t}function h(t){let e=XMLHttpRequest.prototype.open,s=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.open=function(r,n){this._$openUrl=new URL(n,self.location.href),e.apply(this,arguments)},XMLHttpRequest.prototype.send=function(r){new URL(this._$openUrl).pathname==="/exam_room/answer_problem"&&t.call(this,JSON.parse(r)),s.apply(this,arguments)}}function m(){return new Promise((t,e)=>{let s=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(r,n){let o=new URL(n,self.location.href);if(o.pathname=="/exam_room/show_paper"){XMLHttpRequest.prototype.open=s;let i=o.searchParams.get("exam_id");i===null?e(new Error("no `exam_id` in url")):(this.addEventListener("readystatechange",()=>{if(this.readyState===XMLHttpRequest.DONE&&this.status===200){let l=c(JSON.parse(this.responseText));this._$paper=l;let w=JSON.stringify(l);Object.defineProperty(this,"responseText",{get(){return w}})}}),this.addEventListener("load",()=>{t({id:parseInt(i),paper:this._$paper})}))}s.apply(this,arguments)}})}function u(t){return GM_getValue(t,null)}function d(t,e){GM_setValue(t,e)}var p=class{constructor(e,s,r,n){this.name=e,this.show=s,this.hint=r,this.check=n}getOrSet(){let e=u(this.name);return e===null&&(e=x(this.show,this.hint,this.check),d(this.name,e)),e}};function x(t,e,s){let r=self.prompt(`\u8BF7\u8F93\u5165${t}\uFF08${e}\uFF09`);for(;;){if(r!==null&&(s===void 0||s(r)))return r;r=self.prompt(`\u65E0\u6548\u7684${t}\uFF0C\u8BF7\u91CD\u65B0\u8F93\u5165`)}}function g(t){document.querySelectorAll(".header-title").forEach(e=>{let s=document.createElement("a");s.href="javascript:void(0);",s.onclick=t,s.innerHTML=e.innerHTML,e.innerHTML="",e.appendChild(s)})}var a=class{constructor(e){this.ws=e}static connect(e){return new Promise((s,r)=>{let n=new WebSocket(e);n.onerror=o=>r(o),n.onclose=()=>r(new Error("\u670D\u52A1\u5668\u5173\u95ED")),n.onopen=()=>s(new a(n))})}set onmessage(e){this.ws.onmessage=s=>{e(JSON.parse(s.data))}}send(e){this.ws.send(JSON.stringify(e))}};var f=!1,P=new p("username","\u7528\u6237\u540D","\u7531\u5B57\u6BCD\u3001\u6570\u5B57\u3001\u4E0B\u5212\u7EBF\u7EC4\u6210",t=>t.length>0&&t.length<32&&/^[_a-zA-Z]\w+$/.test(t)),y=new p("server_addr","\u670D\u52A1\u5668\u5730\u5740","\u4F8B\u5982\uFF1Alocalhost:9009");m().then(t=>{g(()=>{if(!f){let e=P.getOrSet(),r=`ws://${y.getOrSet()}/login?username=${e}&exam_id=${t.id}`;console.log(`Login: ${r}`),a.connect(r).then(n=>{f=!0,n.onmessage=o=>o.forEach(i=>console.log(i.username,JSON.stringify(i.answers))),h(function(o){n.send(o.results)})}).catch(n=>self.alert(`\u4E0E\u670D\u52A1\u5668\u901A\u4FE1\u65F6\u53D1\u751F\u9519\u8BEF\uFF1A${n}`))}})});})();
