// ==UserScript==
// @name         yuk
// @version      0.0.0
// @match        https://examination.xuetangx.com/exam/*
// @grant        GM.getValue
// @grant        GM.setValue
// @run-at       document-start
// ==/UserScript==

(()=>{"use strict";var e=[,(e,t,n)=>{n.r(t),n.d(t,{Client:()=>i});var o=n(2),r=function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{c(o.next(e))}catch(e){i(e)}}function a(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))};class i{constructor(e){this.ws=e}static login(e,t,n){return r(this,void 0,void 0,(function*(){return new Promise(((r,s)=>{const a=new WebSocket((0,o.newURL)(`ws://${e}/login`,{username:t,exam_id:n})),c=new i(a);a.onopen=()=>{r(c)},a.onerror=s,a.onclose=()=>{s(new Error("server has been closed"))}}))}))}send(e){this.ws.send(JSON.stringify(e))}onmessage(e){this.ws.addEventListener("message",(t=>e(JSON.parse(t.data))))}}},(e,t,n)=>{n.r(t),n.d(t,{hookXHR:()=>i,newURL:()=>r});var o=function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{c(o.next(e))}catch(e){i(e)}}function a(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))};function r(e,t){const n=new URL(e,self.location.origin);for(const[e,o]of Object.entries(null!=t?t:{}))n.searchParams.set(e,o);return n}function i(e){return o(this,void 0,void 0,(function*(){return new Promise(((t,n)=>{const o=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(i,s){e.call(this,r(s),new Promise((e=>{const t=this.send;this.send=function(n){e(n),t.apply(this,arguments),this.send=t}}))).then((e=>{t(e),XMLHttpRequest.prototype.open=o})).catch(n),o.apply(this,arguments)}}))}))}},(e,t,n)=>{var o;function r(e){return e===o.SingleChoice||e===o.MultipleChoice||e===o.Polling}n.r(t),n.d(t,{ProblemType:()=>o,isChoice:()=>r}),function(e){e[e.SingleChoice=1]="SingleChoice",e[e.MultipleChoice=2]="MultipleChoice",e[e.Polling=3]="Polling",e[e.FillBlank=4]="FillBlank",e[e.ShortAnswer=5]="ShortAnswer",e[e.Judgement=6]="Judgement"}(o||(o={}))},(e,t,n)=>{n.r(t),n.d(t,{SERVER:()=>f,UI:()=>m,USERNAME:()=>h});var o=n(3),r=n(5),i=n(15),s=function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{c(o.next(e))}catch(e){i(e)}}function a(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))};class a extends Map{constructor(e){super(),this.def=e}setWith(e,t){var n;super.set(e,t(null!==(n=super.get(e))&&void 0!==n?n:this.def()))}}function c(e){return`${Math.floor(100*e)}%`}class l{constructor(e){const t=document.createElement("div");t.classList.add(r.default.tooltip),e.after(t),this.tooltip=t;e.addEventListener("mouseover",(()=>this.tooltip.setAttribute("data-show",""))),e.addEventListener("mouseout",(()=>this.tooltip.removeAttribute("data-show"))),this.toggle(!0)}toggle(e){this.tooltip.style.visibility=e?"":"hidden"}set content(e){this.tooltip.textContent=e}}class u{constructor(e,t){this.results=new Map;const n=e.ProblemType,r=new Map;switch(n){case o.ProblemType.SingleChoice:case o.ProblemType.MultipleChoice:case o.ProblemType.Polling:case o.ProblemType.Judgement:t.querySelectorAll(".item-body div ul li").forEach(((t,n)=>{r.set(e.Options[n].key,new l(t))}));break;case o.ProblemType.FillBlank:t.querySelectorAll(".item-body div span input").forEach(((e,t)=>{r.set(`${t+1}`,new l(e))}))}this.type=n,this.options=r}updateResult(e,t){this.results.set(e,t)}updateUI(){switch(this.options.forEach((e=>e.content="")),this.type){case o.ProblemType.SingleChoice:case o.ProblemType.MultipleChoice:case o.ProblemType.Polling:case o.ProblemType.Judgement:const e=new a((()=>0));this.results.forEach((t=>{t.forEach((t=>{e.setWith(t,(e=>e+1))}))})),e.forEach(((e,t)=>{this.options.get(t).content=`[${c(e/this.results.size)}]`}));break;case o.ProblemType.FillBlank:const t=new a((()=>new a((()=>0))));this.results.forEach((e=>{Object.entries(e).forEach((([e,n])=>{t.setWith(e,(e=>(e.setWith(n,(e=>e+1)),e)))}))})),t.forEach(((e,t)=>{const[n,o]=[...e.entries()].sort((([e,t],[n,o])=>t-o)).pop();this.options.get(t).content=`[${c(o/this.results.size)}] ${n}`}))}}}class d{constructor(e,t){this.name=e,this.validator=null!=t?t:()=>!0}getValue(){var e;return s(this,void 0,void 0,(function*(){return null!==(e=yield i.default.getValue(this.name))&&void 0!==e?e:yield this.updateValue()}))}updateValue(){return s(this,void 0,void 0,(function*(){let e=yield i.default.getValue(this.name),t=null;for(;;)if(null===t||""===t)if(void 0!==e){if(t=prompt(`Value of "${this.name}" is "${e}"`),null===t||""===t)return e}else t=prompt(`Input "${this.name}"`);else{if(this.validator(t))return yield i.default.setValue(this.name,t),t;t=prompt(`Invalid value, input "${this.name}" again`)}}))}}function p(e,t){const n=document.createElement("span");return n.classList.add(r.default.buttonText),n.textContent=e,n.addEventListener("click",t),n}const h=new d("username",(e=>/[_\w][_\w\d]+/.test(e))),f=new d("server");class m{constructor(e){const t=document.querySelector(".header-title");t.appendChild(p("U",(()=>h.updateValue()))),t.appendChild(p("S",(()=>f.updateValue())));const n=new Map;document.querySelectorAll(".exam-main--body div .subject-item").forEach(((t,o)=>{const r=e.data.problems[o];n.set(r.problem_id,new u(r,t))})),this.problems=n}updateAnswer({username:e,answers:t}){t.forEach((({problem_id:t,result:n})=>{var o;null===(o=this.problems.get(t))||void 0===o||o.updateResult(e,n)}))}updateUI(){this.problems.forEach((e=>e.updateUI()))}}},(e,t,n)=>{n.r(t),n.d(t,{default:()=>y});var o=n(6),r=n.n(o),i=n(7),s=n.n(i),a=n(8),c=n.n(a),l=n(9),u=n.n(l),d=n(10),p=n.n(d),h=n(11),f=n.n(h),m=n(12),v={};v.styleTagTransform=f(),v.setAttributes=u(),v.insert=c().bind(null,"head"),v.domAPI=s(),v.insertStyleElement=p();r()(m.default,v);const y=m.default&&m.default.locals?m.default.locals:void 0},e=>{var t=[];function n(e){for(var n=-1,o=0;o<t.length;o++)if(t[o].identifier===e){n=o;break}return n}function o(e,o){for(var i={},s=[],a=0;a<e.length;a++){var c=e[a],l=o.base?c[0]+o.base:c[0],u=i[l]||0,d="".concat(l," ").concat(u);i[l]=u+1;var p=n(d),h={css:c[1],media:c[2],sourceMap:c[3],supports:c[4],layer:c[5]};if(-1!==p)t[p].references++,t[p].updater(h);else{var f=r(h,o);o.byIndex=a,t.splice(a,0,{identifier:d,updater:f,references:1})}s.push(d)}return s}function r(e,t){var n=t.domAPI(t);n.update(e);return function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;n.update(e=t)}else n.remove()}}e.exports=function(e,r){var i=o(e=e||[],r=r||{});return function(e){e=e||[];for(var s=0;s<i.length;s++){var a=n(i[s]);t[a].references--}for(var c=o(e,r),l=0;l<i.length;l++){var u=n(i[l]);0===t[u].references&&(t[u].updater(),t.splice(u,1))}i=c}}},e=>{e.exports=function(e){var t=e.insertStyleElement(e);return{update:function(n){!function(e,t,n){var o="";n.supports&&(o+="@supports (".concat(n.supports,") {")),n.media&&(o+="@media ".concat(n.media," {"));var r=void 0!==n.layer;r&&(o+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),o+=n.css,r&&(o+="}"),n.media&&(o+="}"),n.supports&&(o+="}");var i=n.sourceMap;i&&"undefined"!=typeof btoa&&(o+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(i))))," */")),t.styleTagTransform(o,e,t.options)}(t,e,n)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}},e=>{var t={};e.exports=function(e,n){var o=function(e){if(void 0===t[e]){var n=document.querySelector(e);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}t[e]=n}return t[e]}(e);if(!o)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");o.appendChild(n)}},(e,t,n)=>{e.exports=function(e){var t=n.nc;t&&e.setAttribute("nonce",t)}},e=>{e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},e=>{e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}},(e,t,n)=>{n.r(t),n.d(t,{default:()=>a});var o=n(13),r=n.n(o),i=n(14),s=n.n(i)()(r());s.push([e.id,".__yuk_xrCwn7VvvG6kgp7rEzuu {\n  position: absolute;\n  visibility: hidden;\n  display: block;\n  z-index: 1;\n  color: rgba(0, 0, 0, 0.15);\n  background-color: white;\n  padding: 0.1rem;\n  border-radius: 0.3rem;\n  font-weight: bold;\n  font-size: 0.3rem;\n  left: 0;\n  bottom: 0;\n}\n\n.__yuk_xrCwn7VvvG6kgp7rEzuu[data-show] {\n  visibility: visible;\n}\n\n.__yuk_Pe8cc3UkSAB5IgoDkaOw {\n  cursor: pointer;\n  margin-left: 0.25rem;\n  text-decoration: underline;\n}\n",""]),s.locals={tooltip:"__yuk_xrCwn7VvvG6kgp7rEzuu",buttonText:"__yuk_Pe8cc3UkSAB5IgoDkaOw"};const a=s},e=>{e.exports=function(e){return e[1]}},e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var n="",o=void 0!==t[5];return t[4]&&(n+="@supports (".concat(t[4],") {")),t[2]&&(n+="@media ".concat(t[2]," {")),o&&(n+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),n+=e(t),o&&(n+="}"),t[2]&&(n+="}"),t[4]&&(n+="}"),n})).join("")},t.i=function(e,n,o,r,i){"string"==typeof e&&(e=[[null,e,void 0]]);var s={};if(o)for(var a=0;a<this.length;a++){var c=this[a][0];null!=c&&(s[c]=!0)}for(var l=0;l<e.length;l++){var u=[].concat(e[l]);o&&s[u[0]]||(void 0!==i&&(void 0===u[5]||(u[1]="@layer".concat(u[5].length>0?" ".concat(u[5]):""," {").concat(u[1],"}")),u[5]=i),n&&(u[2]?(u[1]="@media ".concat(u[2]," {").concat(u[1],"}"),u[2]=n):u[2]=n),r&&(u[4]?(u[1]="@supports (".concat(u[4],") {").concat(u[1],"}"),u[4]=r):u[4]="".concat(r)),t.push(u))}},t}},(e,t,n)=>{n.r(t),n.d(t,{default:()=>o});const o={getValue:async e=>await GM.getValue(e),setValue:async(e,t)=>await GM.setValue(e,t)}}],t={};function n(o){var r=t[o];if(void 0!==r)return r.exports;var i=t[o]={id:o,exports:{}};return e[o](i,i.exports,n),i.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var o in t)n.o(t,o)&&!n.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var o={};(()=>{n.r(o),n.d(o,{sortPaper:()=>a});var e=n(1),t=n(2),r=n(3),i=n(4),s=function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{c(o.next(e))}catch(e){i(e)}}function a(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))};function a(e){return e.data.problems.sort(((e,t)=>e.problem_id-t.problem_id)),e.data.problems.forEach((e=>{(0,r.isChoice)(e.ProblemType)&&e.Options.sort(((e,t)=>e.key<t.key?-1:1))})),e}(function(){return s(this,void 0,void 0,(function*(){const n=yield i.USERNAME.getValue(),o=yield i.SERVER.getValue(),{client:r,examId:c,paper:l}=yield function(n,o){return s(this,void 0,void 0,(function*(){return(0,t.hookXHR)((function(t){return new Promise((r=>{"/exam_room/show_paper"===t.pathname&&(this.addEventListener("readystatechange",(()=>{if(this.readyState==XMLHttpRequest.DONE){const e=JSON.stringify(a(JSON.parse(this.responseText)));Object.defineProperties(this,{responseText:{get:()=>e}})}})),this.addEventListener("load",(()=>{const i=t.searchParams.get("exam_id");r(e.Client.login(n,o,i).then((e=>({client:e,examId:i,paper:JSON.parse(this.responseText)}))))})))}))}))}))}(o,n),u=new i.UI(l);console.log(l),r.onmessage((e=>{console.log(e),e.forEach((e=>{u.updateAnswer(e)})),u.updateUI()}));const d=yield fetch((0,t.newURL)("/exam_room/cache_results",{exam_id:c}).toString()).then((e=>e.json()));r.send(d.data.results),yield(0,t.hookXHR)((function(e,t){return new Promise((()=>s(this,void 0,void 0,(function*(){if("/exam_room/answer_problem"===e.pathname){const e=JSON.parse(yield t);r.send(e.results)}}))))}))}))})().catch(console.error)})()})();