// ==UserScript==
// @name         yuk
// @version      0.1.0
// @match        https://examination.xuetangx.com/exam/*
// @grant        GM_getValue
// @grant        GM_setValue
// @run-at       document-start
// ==/UserScript==

(()=>{function l(n){(e=>{XMLHttpRequest.prototype.send=function(t){this.addEventListener("load",()=>{n.call(this,t)&&(XMLHttpRequest.prototype.send=e)}),e.call(this,t)}})(XMLHttpRequest.prototype.send)}function p(n){return GM_getValue(n,null)}function c(n,e){GM_setValue(n,e)}var a=class{constructor(e,t,s,r){this.name=e,this.show=t,this.hint=s,this.check=r}getOrSet(){let e=p(this.name);return e===null&&(e=g(this.show,this.hint,this.check),c(this.name,e)),e}};function g(n,e,t){let s=self.prompt(`\u8BF7\u8F93\u5165${n}\uFF08${e}\uFF09`);for(;;){if(s!==null&&(t===void 0||t(s)))return s;s=self.prompt(`\u65E0\u6548\u7684${n}\uFF0C\u8BF7\u91CD\u65B0\u8F93\u5165`)}}function u(n){document.querySelectorAll("div.header-title").forEach(e=>{let t=document.createElement("a");t.href="javascript:void(0);",t.onclick=n,t.innerHTML=e.innerHTML,e.innerHTML="",e.appendChild(t)})}var i=class{constructor(e){this.ws=e}static new(e){return new Promise((t,s)=>{let r=new WebSocket(e);r.onerror=o=>s(o),r.onclose=()=>s(new Error("\u670D\u52A1\u5668\u5173\u95ED")),r.onopen=()=>t(new i(r))})}set onmessage(e){this.ws.onmessage=t=>{e(JSON.parse(t.data))}}send(e){this.ws.send(JSON.stringify(e))}};function d(){return new Promise(n=>{l(function(){let e=new URL(this.responseURL);if(e.pathname=="/exam_room/show_paper"){let t=e.searchParams.get("exam_id");if(t===null)throw new Error("no `exam_id` in url");return n({id:parseInt(t),paper:JSON.parse(this.responseText)}),!0}return!1})})}var m=!1,f=new a("username","\u7528\u6237\u540D","\u7531\u5B57\u6BCD\u3001\u6570\u5B57\u3001\u4E0B\u5212\u7EBF\u7EC4\u6210",n=>n.length>0&&n.length<32&&/^[_a-zA-Z]\w+$/.test(n)),w=new a("server_addr","\u670D\u52A1\u5668\u5730\u5740","\u4F8B\u5982\uFF1Alocalhost:9009");d().then(n=>{u(()=>{if(!m){let e=f.getOrSet(),t=w.getOrSet();console.log(e,t,n.id,n.paper.data.title),i.new(`ws://${t}/login?username=${e}&exam_id=${n.id}`).then(s=>{m=!0,s.onmessage=r=>r.forEach(o=>console.log(o.username,JSON.stringify(o.answers))),l(function(r){if(new URL(this.responseURL).pathname==="/exam_room/answer_problem"){let h=JSON.parse(r);s.send(h.results)}return!1})}).catch(s=>self.alert(`\u4E0E\u670D\u52A1\u5668\u901A\u4FE1\u65F6\u53D1\u751F\u9519\u8BEF\uFF1A${s}`))}})});})();
